<!DOCTYPE html>
<html class="ui-mobile"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<title>nEDM Base</title> 
	
	<link rel="stylesheet" href="/nedm%2Fhead/_design/nedm_head/style/jquery.mobile-1.4.0-pre.css" />
	<script src="/nedm%2Fhead/_design/nedm_head/modules.js"></script>
	<script src="/nedm%2Fhead/_design/nedm_head/scripts/nedm-base.js"></script>
	<style> .center { text-align: center; } </style>
	<style> type="text/css">
	#div_g {
	position: absolute;
	left: 10px;
	right: 10px;
	top: 40px;
	bottom: 100px;
	}
	</style>

</head> 

<body class="ui-mobile-viewport ui-overlay-c"> 

<!-- Start of splash page: #one -->

<div data-role="page" id="db_monitor">
    <div class="headerChild"> 
    </div>

    <!--<div class="headerKid">
    </div>
    <script>$('headerKid').load('./index.html #standardHeader');</script> -->
    <div align="center" data-role="content" id="contentConfirmation" name="contentConfirmation">
        <h1 >Monitor</h1>
	<div id="div_g">

    </div>

		<label for="size">number of displayed values</label>
		<input type="number" step="1" value="100" id="size" onchange="changeSize(this.value)"/>

		<script type="text/javascript">
      			var size = $('#size')[0].value;
			
function changeSize(val) {
	size=val;

	if (data.length>size) {
		var len = data.length-size;
		for (var i = 0; i< len; i++) {
			data.shift();
		}
	}
	if (data.length<size) {
		/*$.getJSON( "/nedm%2Ftemperature/_changes?limit="+size+"&include_docs=true&descending=true", function(f)
			{
			for (var i=data.length; i < size; i++) {
				if (f.results[i].id!="_design/nedm_default") {	
				//if (f.results[i].type=="data2") {						
					data.unshift([
						new Date(f.results[i].doc.timestamp),
						f.results[i].doc.value['fake_device']
					]);
				}
			}

		});*/
		$.getJSON( "/nedm%2Ftemperature/_design/nedm_default/_view/slow_control_time?group=true&descending=true&limit="+size, function(f)
			{
			for (var i=data.length; i < size; i++) {
				//if (f.results[i].type=="data2") {										
					data.unshift([
						new Date(
							f.rows[i].key[1],
							f.rows[i].key[2],
							f.rows[i].key[3],
							f.rows[i].key[4],
							f.rows[i].key[5],
							f.rows[i].key[6],0
							),
						f.rows[i].value[0]
					]);
			}
		});
	}

	g.updateOptions( { 'file': data } );
}

var data = [];

/*$.getJSON( "/nedm%2Ftemperature/_changes?limit="+size+"&include_docs=true&descending=true", function(f) {
	for (var i=size-1; i >= 0; i--) {
		if (f.results[i].id!="_design/nedm_default") {
		//if (f.results[i].type=="data2") {
			data.push([
				new Date(f.results[i].doc.timestamp),
				f.results[i].doc.value['fake_device']
			]);
		}
	}
});*/

//http://localhost:5984/nedm%2Ftemperature/_design/nedm_default/_view/slow_control_time?group=true&descending=true&limit=10

$.getJSON( "/nedm%2Ftemperature/_design/nedm_default/_view/slow_control_time?group=true&descending=true&limit="+size, function(f) {
	for (var i=0; i < size; i++) {
		data.push([
			new Date(
				f.rows[i].key[1],
				f.rows[i].key[2],
				f.rows[i].key[3],
				f.rows[i].key[4],
				f.rows[i].key[5],
				f.rows[i].key[6],0
				),
			f.rows[i].value[0]
		]);
	}
});

      
var g = new dygraphs.Dygraph(
	$('#div_g')[0],
	data,
      	{
		drawPoints: true,
      		showRoller: false,
      		labels: ['Time', 'Value']
      	}
);
     
g.resize(window.innerWidth,400);
g.updateOptions( { 'file': data } );
    
var eventHandling = function () {
	// define the event handling function
	if (window.EventSource) {
		var source = new EventSource("/nedm%2Ftemperature/_changes?feed=eventsource&since=now");
  
		var sourceListener = function(e) {
			var change = JSON.parse(e.data);
				$.getJSON( "/nedm%2Ftemperature/_design/nedm_default/_view/latest_value?group=true", function(f) {
					if (data.length == 0 || f.rows[1].value.timestamp!=data[data.length-1][0]) {
						data.push([
							new Date(f.rows[1].value.timestamp),
							f.rows[1].value.value
						]);
					
						data.shift();
       						g.updateOptions( { 'file': data } );
					}
       				});
			}; 
	};
	source.addEventListener('message', sourceListener , false);
};

$(document).on('pageinit', eventHandling);
// start listening for events
			
	    </script>
    </div>
</div>

</body>
</html>
