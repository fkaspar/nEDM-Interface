<!DOCTYPE html>
<html class="ui-mobile"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<title>nEDM Base</title> 
	
	<link rel="stylesheet" href="../../../nedm%2Fhead/_design/nedm_head/style/jquery.mobile-1.4.0-pre.css" />
	<script src="../../../nedm%2Fhead/_design/nedm_head/scripts/jquery-1.9.0.js"></script>
	<script src="modules.js"></script>
	<script src="../../../nedm%2Fhead/_design/nedm_head/scripts/nedm-base.js"></script>
	<script src="../../../nedm%2Fhead/_design/nedm_head/scripts/jquery.mobile-1.4.0-pre.js"></script>
	<script src="../../../nedm%2Fhead/_design/nedm_head/scripts/dygraph-combined.js"></script>
	<style> .center { text-align: center; } </style>
	<style> type="text/css">
	#div_g {
	position: absolute;
	left: 10px;
	right: 10px;
	top: 40px;
	bottom: 100px;
	}
	</style>

</head> 

<body class="ui-mobile-viewport ui-overlay-c"> 

<!-- Start of splash page: #one -->

<div data-role="page" id="db_monitor">
    <div class="headerChild"> 
    </div>

    <!--<div class="headerKid">
    </div>
    <script>$('headerKid').load('./index.html #standardHeader');</script> -->
    <div align="center" data-role="content" id="contentConfirmation" name="contentConfirmation">
        <h1 >Monitor</h1>
	<div id="div_g">

    </div>
<!--		<select id="entry_14" onchange="myfunction(this.value);">-->
<!--    				<option value=30>big</option> -->
<!--  				<option  value=20>small</option>-->
<!--			</select>-->

		<label for="size">number of displayed values</label>
		<input type="number" step="1" value="10" id="size" onchange="changeSize(this.value)"/>

<!--		<div><input type="submit" value="Submit" id="submit" onsubmit="myfunction2()"></div>-->

		<script type="text/javascript">
			
			var size = document.getElementById('size').value;
			
			function changeSize(val) {
        			size=val;
				if (data.length>size) {
					var len = data.length-size;
					for (var i = 0; i< len; i++) {
						data.shift();
					}
				}
				if (data.length<size) {
					$.getJSON( "/nedm%2Ftemperature/_changes?limit="+size+"&include_docs=true&descending=true", function(f)
						{
						for (var i=data.length; i < size; i++) {
							if (f.results[i].id!="_design/nedm_default") {							
								data.unshift([
								new Date(f.results[i].doc.timestamp),
								f.results[i].doc.valdict['fake_device']
								]);}
						}
	 				});
				}
        			g.updateOptions( { 'file': data } );
    			}

      			var data = [];
      			var t = new Date();

			$.getJSON( "/nedm%2Ftemperature/_changes?limit="+size+"&include_docs=true&descending=true", function(f) {
				for (var i=size-1; i >= 0; i--) {
					if (f.results[i].id!="_design/nedm_default") {
						data.push([
						new Date(f.results[i].doc.timestamp),
						f.results[i].doc.valdict['fake_device']
						]);
					}
				}
	 		});
      
			var g = new Dygraph(
				document.getElementById("div_g"),
				data,
                          	{
                            		drawPoints: true,
                            		showRoller: false,
                            		labels: ['Time', 'Value']
                          	}
			);
      
      			g.resize(window.innerWidth,400);
    
                        var eventHandling = function () {
			// define the event handling function
			if (window.EventSource) {
				var source = new EventSource("/nedm%2Ftemperature/_changes?feed=eventsource&since=now");
  
				var sourceListener = function(e) {
					var change = JSON.parse(e.data);

					$.getJSON( "/nedm%2Ftemperature/"+change.id, function(f) {
							if (f.id!="_design/nedm_default") {
								data.push([
								new Date(f.timestamp),
								f.valdict['fake_device']
								]);
							}
						data.shift();
        					g.updateOptions( { 'file': data } );
	 
           				});
				}; 
			};
                        source.addEventListener('message', sourceListener , false);
 
                        };
                        $(document).on('pageinit', eventHandling);
			// start listening for events
			
	    </script>
    </div>
</div>

</body>
</html>
